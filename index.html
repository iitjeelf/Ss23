<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>LFJC Online Exam</title>
<style>
/* === DESIGN KEPT EXACTLY AS REQUESTED === */
body{font-family:"SF Pro Display",Arial,sans-serif;margin:0;background:#fff;color:#000;}
header{background:linear-gradient(145deg,#E6E6FA,#D8BFD8);color:#4B0082;text-align:center;padding:20px;font-size:36px;font-weight:700;letter-spacing:1.5px;box-shadow:0 5px #aaa;text-shadow:0 1px 2px #fff;}
#studentEntry,#examArea{padding:20px;text-align:center;}
.form-group{display:flex;flex-direction:row;align-items:center;justify-content:center;margin-bottom:15px;}
.form-group label{font-size:1.15rem;font-weight:600;margin-right:10px;color:#4B0082;width:120px;text-align:right;}
input[type="text"]{padding:10px 12px;font-size:1.1rem;border-radius:10px;border:1.5px solid #4B0082;outline:none;min-width:250px;}
input.error{animation:glowRed 0.5s alternate infinite;border-color:red;}
@keyframes glowRed{0%{box-shadow:0 0 5px red;}100%{box-shadow:0 0 15px red;}}
button{position:relative;overflow:hidden;cursor:pointer;border:none;border-radius:12px;transition:all .18s ease;box-shadow:0 6px #aaa;background:linear-gradient(to bottom,#fafaff,#dcd6f7);color:#4B0082;font-weight:600;padding:10px 20px;font-size:18px;}
button:hover{transform:translateY(-2px);box-shadow:0 8px 15px rgba(0,0,0,.28);}
button:active{transform:translateY(3px) scale(.98);}
.optBtn{font-size:16px;padding:8px 18px;margin:6px;border:2px solid #4B0082;background:#fff;border-radius:8px;box-shadow:0 5px #aaa;}
.optBtn.selected{background:#32CD32;color:#fff;border-color:#2fa92f;}
.navContainer{display:flex;justify-content:center;gap:10px;margin:10px 0;flex-wrap:wrap}
.navBtn{font-size:16px;padding:10px 20px;border-radius:8px;color:#fff;font-weight:bold;cursor:pointer;background:linear-gradient(145deg,#1E90FF,#4682B4);}
#markReviewBtn{background:linear-gradient(145deg,#ffb84d,#ff9900)}
#submitBtn{background:linear-gradient(145deg,#c8b88a,#b49e60)}
#timerEl{font-size:20px;font-weight:bold;color:#4B0082;padding:6px 12px;border-radius:6px;background:#f0f0ff;display:inline-block;transition: all 0.3s ease;}
/* blink animation used for timer and student-info when applied (.blink) */
@keyframes blinkTimer{0%{background:#ff6666;color:#fff;}50%{background:#fff;color:#4B0082;}100%{background:#ff6666;color:#fff;}}
.blink{animation:blinkTimer 1s infinite;}
#paletteContainer button{width:36px;height:36px;border-radius:50%;font-size:14px;margin:3px;border:1px solid #4B0082;background:#E6E6FA;color:#4B0082;}
#paletteContainer button.selected{background:#32CD32;color:#fff;border-color:#2fa92f}
#paletteContainer button.reviewed{background:yellow;color:#000}
#paletteContainer button.current{border:3px solid red}
footer{background:#E6E6FA;color:#4B0082;padding:10px;text-align:center;font-weight:bold;position:fixed;width:100%;bottom:0;}
.sectionTitle{font-size:22px;color:#4B0082;font-weight:bold;margin-bottom:8px;}
img.questionImg{max-width:100%;border-radius:10px;}
.glow {animation: glowPulse 1.6s infinite alternate;box-shadow:0 8px 18px rgba(75,0,130,0.12);}
@keyframes glowPulse{0% { box-shadow:0 6px 10px rgba(75,0,130,0.06); transform:translateY(0); } 50% { box-shadow:0 12px 30px rgba(75,0,130,0.14); transform:translateY(-2px); } 100% { box-shadow:0 6px 10px rgba(75,0,130,0.06); transform:translateY(0); }}
#fullRedOverlay{ position:fixed; left:0; top:0; width:100%; height:100%; display:none; z-index:9999; pointer-events:auto; }
#fullRedOverlay .overlay-slice{ position:absolute; top:0; bottom:0; width:calc(100%/7); height:100%; background:red; left:0; transition:opacity .45s ease, transform .45s ease; }
#accessDeniedBox{ position:fixed; left:50%; top:40%; transform:translate(-50%,-50%); z-index:10000; color:#fff; text-align:center; display:none; pointer-events:auto; }
#accessDeniedBox h1{ font-size:48px; font-weight:900; margin:0 0 18px 0; color:#fff; text-shadow:0 2px 6px rgba(0,0,0,0.4); }
#callAdminBtn{ padding:12px 22px; border-radius:12px; font-weight:800; }
.confirmModal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.45);display:none;align-items:center;justify-content:center;z-index:10001;}
.confirmBox{background:#fff;padding:20px;border-radius:12px;min-width:280px;text-align:center;box-shadow:0 5px 15px rgba(0,0,0,0.3);}
.confirmBox p{font-size:18px;color:#4B0082;margin-bottom:15px;}
.confirmBox button{margin:0 10px;padding:8px 16px;font-size:16px;cursor:pointer;}
@media(max-width:600px){ #accessDeniedBox h1{font-size:28px;} #callAdminBtn{padding:10px 14px;} .form-group{flex-direction:column;align-items:flex-start;} .form-group label{text-align:left;width:auto;margin-bottom:5px;} }
</style>
</head>
<body>
<header>LFJC ONLINE EXAMINATION</header>

<div id="studentEntry">
  <div class="form-group"><label>Name</label><input type="text" id="stuName" placeholder="Only letters & spaces" autocomplete="off" autocapitalize="words"></div>
  <div class="form-group"><label>Section</label><input type="text" id="stuSection" placeholder="Letters & digits" autocomplete="off"></div>
  <div class="form-group"><label>Roll</label><input type="text" id="stuRoll" placeholder="Digits only" autocomplete="off"></div>
  <div class="form-group"><label>Admission No</label><input type="text" id="stuAdm" placeholder="Digits only" autocomplete="off"></div>
  <div class="form-group"><button id="stuStartBtn" style="display:none;">Start Exam</button></div>
  <p id="studentMsg" style="height:1em;margin:6px 0;"></p> <!-- kept but intentionally left blank per request -->
</div>

<div id="examArea" style="display:none;">
  <div id="examHeader" style="display:flex;justify-content:space-between;align-items:center;">
    <div id="stuInfo" style="text-align:left;font-weight:bold;"></div>
    <div id="timerEl">ðŸ•’ 00:00</div>
  </div>

  <!-- Qn/Total centered above the question -->
  <div id="stuQInfo" style="text-align:center;font-weight:bold;margin-top:5px;"></div>

  <div id="questionContainer" style="text-align:center;margin-top:10px;"></div>

  <div class="navContainer">
    <button class="navBtn" id="prevBtn">â¬… Previous</button>
    <button class="navBtn" id="markReviewBtn">Review</button> <!-- text will toggle to Unreview when question reviewed -->
    <button class="navBtn" id="nextBtn">Next âž¡</button>
    <button class="navBtn" id="submitBtn">Submit Exam</button>
  </div>

  <div id="paletteContainer"></div>
</div>

<footer>LFJC@2025 All rights reserved</footer>

<div id="fullRedOverlay" aria-hidden="true"></div>
<div id="accessDeniedBox" aria-hidden="true">
  <h1 id="accessDeniedText">ACCESS DENIED</h1>
  <div><button id="callAdminBtn" class="glow">CALL ADMIN</button></div>
</div>

<div class="confirmModal" id="confirmModal">
  <div class="confirmBox">
    <p id="confirmText">Confirm?</p>
    <button id="confirmYes">Yes</button>
    <button id="confirmNo">No</button>
  </div>
</div>

<script>
/* ====== CONFIG / DATA ====== */
const MARK_PER_CORRECT=1, MARK_PER_WRONG=-0.25;
let images=["1.png","2.png","3.png","4.png","5.png","6.png"];
let answerKey=["A","B","C","D","A","B"];
const subjects=["Maths","Physics","Chemistry"];
let examData={files:[],subjectNames:[],keys:[]};
let progress=null, timerInterval=null, pendingAttempt=null;
const LS_KEY='lfjc_attempts_v1';

/* ====== HELPERS ====== */
function shuffleArray(arr){const copy=arr.slice();for(let i=copy.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[copy[i],copy[j]]=[copy[j],copy[i]];}return copy;}
function makeStudentIdRaw(name,sec,roll,adm){return `${name.trim().toLowerCase()}|${sec.trim().toLowerCase()}|${roll.trim()}|${adm.trim()}`;}
function storeAttemptLocal(student){
  try{
    const raw=makeStudentIdRaw(student.name,student.sec,student.roll,student.adm);
    const attempts=JSON.parse(localStorage.getItem(LS_KEY)||'[]');
    attempts.push({raw,t:Date.now()});
    localStorage.setItem(LS_KEY,JSON.stringify(attempts));
  }catch(e){}
}
function isBlockedByPrevious(name,sec,roll,adm){
  try{
    const attempts=JSON.parse(localStorage.getItem(LS_KEY)||'[]');
    const cutoff=Date.now()-(24*60*60*1000);
    for(const a of attempts){
      if(a.t<cutoff) continue;
      const parts=(a.raw||'').split('|');
      if(parts.length<4) continue;
      const [sn,ss,sr,sa]=parts; let match=0;
      if(sn && name.toLowerCase().trim()===sn) match++;
      if(ss && sec.toLowerCase().trim()===ss) match++;
      if(sr && roll.trim()===sr) match++;
      if(sa && adm.trim()===sa) match++;
      if(match>=2) return true;
    }
  }catch(e){}
  return false;
}

/* ====== PREPARE EXAM DATA ====== */
function prepareExamData(){
  examData.files=[]; examData.subjectNames=[]; examData.keys=[];
  const total=images.length; const base=Math.floor(total/3); let rem=total%3; let start=0;
  const groups=[];
  for(let s=0;s<3;s++){
    const count = base + (rem>0?1:0); rem--;
    const groupImgs = images.slice(start,start+count);
    const groupKeys = answerKey.slice(start,start+count);
    start+=count;
    const idxs = Array.from({length:groupImgs.length},(_,i)=>i);
    const shuffledIdxs = shuffleArray(idxs);
    const shuffledImgs = shuffledIdxs.map(i=>groupImgs[i]);
    const shuffledKeys = shuffledIdxs.map(i=>groupKeys[i]);
    groups.push({name:subjects[s],imgs:shuffledImgs,keys:shuffledKeys});
  }
  const shuffledGroups = shuffleArray(groups);
  shuffledGroups.forEach(g=>{
    g.imgs.forEach((img,i)=>{
      examData.files.push(img);
      examData.keys.push(g.keys[i]);
      examData.subjectNames.push(g.name);
    });
  });
}

/* ====== VALIDATION (red blink only; no warning text) ====== */
function validateStudentInputs(){
  const n=document.getElementById('stuName'), s=document.getElementById('stuSection'), r=document.getElementById('stuRoll'), a=document.getElementById('stuAdm');
  const btn=document.getElementById('stuStartBtn'), msg=document.getElementById('studentMsg');
  const vn=/^[A-Za-z .]+$/.test(n.value), vs=/^[A-Za-z0-9]+$/.test(s.value), vr=/^[0-9]+$/.test(r.value), va=/^[0-9]+$/.test(a.value);
  n.classList.toggle('error', !vn && n.value!=="");
  s.classList.toggle('error', !vs && s.value!=="");
  r.classList.toggle('error', !vr && r.value!=="");
  a.classList.toggle('error', !va && a.value!=="");
  // per your request: no visible warning text on first page
  msg.textContent = "";
  const allValid = vn && vs && vr && va;
  btn.style.display = allValid ? 'inline-block' : 'none';
  if(allValid) btn.classList.add('glow'); else btn.classList.remove('glow');
  return allValid;
}
['stuName','stuSection','stuRoll','stuAdm'].forEach(id=>document.getElementById(id).addEventListener('input',validateStudentInputs));

/* ====== CONFIRM MODAL ====== */
function showConfirm(text,callback){
  const modal=document.getElementById('confirmModal');
  document.getElementById('confirmText').textContent=text;
  modal.style.display='flex';
  document.getElementById('confirmYes').onclick=()=>{ modal.style.display='none'; callback(true); };
  document.getElementById('confirmNo').onclick=()=>{ modal.style.display='none'; callback(false); };
}

/* ====== START EXAM ====== */
document.getElementById('stuStartBtn').onclick = ()=>{
  if(!validateStudentInputs()) return;
  const name=document.getElementById('stuName').value.trim();
  const sec=document.getElementById('stuSection').value.trim();
  const roll=document.getElementById('stuRoll').value.trim();
  const adm=document.getElementById('stuAdm').value.trim();
  pendingAttempt = {name,sec,roll,adm};
  if(isBlockedByPrevious(name,sec,roll,adm)){
    // clear inputs and show overlay (keeps previous behavior)
    document.getElementById('stuName').value='';document.getElementById('stuSection').value='';document.getElementById('stuRoll').value='';document.getElementById('stuAdm').value='';
    document.getElementById('stuStartBtn').style.display='none';
    showRedOverlay();
    return;
  }
  showConfirm("Are you sure you want to START the exam? Once started, timer will begin.", ok=>{
    if(!ok){ pendingAttempt=null; return; }
    prepareExamData();
    progress = {
      answers: Array(examData.files.length).fill(null),
      review: Array(examData.files.length).fill(false),
      currentIndex: 0,
      student: {name,sec,roll,adm},
      timeLeftSec: 5*60
    };
    document.getElementById('studentEntry').style.display='none';
    document.getElementById('examArea').style.display='block';
    renderQuestion(); renderPalette(); startTimer(); updateNavButtons(); updateReviewButton();
  });
};

/* ====== TIMER (blink logic + auto-submit with alert) ====== */
function startTimer(){
  const timerEl=document.getElementById('timerEl');
  const stuInfo=document.getElementById('stuInfo');

  // ensure initial values shown
  timerEl.classList.remove('blink');
  stuInfo.classList.remove('blink');
  timerEl.textContent = `ðŸ•’ ${Math.floor(progress.timeLeftSec/60).toString().padStart(2,'0')}:${(progress.timeLeftSec%60).toString().padStart(2,'0')}`;
  stuInfo.textContent = `${progress.student.name} | ${progress.student.sec} | ${progress.student.roll} | ${progress.student.adm}`;

  if(timerInterval) clearInterval(timerInterval);
  timerInterval = setInterval(()=>{
    if(progress.timeLeftSec <= 0){
      clearInterval(timerInterval);
      alert("â° Time Up! Submitting automaticallyâ€¦");
      submitExam();
      return;
    }
    progress.timeLeftSec--;
    const m = Math.floor(progress.timeLeftSec/60);
    const s = progress.timeLeftSec % 60;
    timerEl.textContent = `ðŸ•’ ${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;

    // last 5 minutes -> timer blinks
    if(progress.timeLeftSec <= 5*60) timerEl.classList.add('blink');
    else timerEl.classList.remove('blink');

    // last 1 minute -> timer and student info blink
    if(progress.timeLeftSec <= 60){ stuInfo.classList.add('blink'); timerEl.classList.add('blink'); }
    else { stuInfo.classList.remove('blink'); /* timer handled above */ }
  }, 1000);
}

/* ====== QUESTIONS & OPTIONS (select/deselect) ====== */
function renderQuestion(){
  const q=document.getElementById('questionContainer');
  const idx = progress.currentIndex;
  const file = examData.files[idx];
  const subj = examData.subjectNames[idx];
  document.getElementById('stuQInfo').textContent = `Question ${idx+1} / ${examData.files.length}`;
  q.innerHTML = `<div class="sectionTitle">${subj}</div><img src="${file}" class="questionImg" alt="Q${idx+1}"><br>`;
  ["A","B","C","D"].forEach(opt=>{
    const btn=document.createElement('button'); btn.className='optBtn'; btn.textContent=opt;
    if(progress.answers[idx]===opt) btn.classList.add('selected');
    btn.onclick = ()=>{
      if(progress.answers[idx]===opt) progress.answers[idx]=null;
      else progress.answers[idx]=opt;
      renderPalette(); renderQuestion();
    };
    q.appendChild(btn);
  });
  updateReviewButton();
}

/* ====== NAVIGATION ====== */
const prevBtn = document.getElementById('prevBtn');
const nextBtn = document.getElementById('nextBtn');
const submitBtn = document.getElementById('submitBtn');
const markReviewBtn = document.getElementById('markReviewBtn');

// prev/next
prevBtn.onclick = ()=>{ if(progress.currentIndex>0){ progress.currentIndex--; renderQuestion(); renderPalette(); updateNavButtons(); } };
nextBtn.onclick = ()=>{ if(progress.currentIndex<examData.files.length-1){ progress.currentIndex++; renderQuestion(); renderPalette(); updateNavButtons(); } };

// submit handler (confirmation + submit)
submitBtn.onclick = ()=>{
  showConfirm("Are you sure you want to SUBMIT the exam?", ok=>{ if(ok) submitExam(); });
};

/* ====== REVIEW / UNREVIEW button behavior (text only changes) ====== */
function updateReviewButton(){
  if(!progress) return;
  if(progress.review[progress.currentIndex]) markReviewBtn.textContent = 'Unreview';
  else markReviewBtn.textContent = 'Review';
}
markReviewBtn.onclick = ()=>{
  if(!progress) return;
  progress.review[progress.currentIndex] = !progress.review[progress.currentIndex];
  renderPalette();
  updateReviewButton();
};

/* ====== PALETTE ====== */
function renderPalette(){
  const container=document.getElementById('paletteContainer'); container.innerHTML='';
  progress.answers.forEach((ans,i)=>{
    const b=document.createElement('button'); b.textContent = i+1;
    b.className=''; // reset
    // if reviewed -> show reviewed color and remove selected highlight per request
    if(progress.review[i]) b.classList.add('reviewed');
    else if(progress.answers[i]) b.classList.add('selected');
    if(i===progress.currentIndex) b.classList.add('current');
    b.onclick = ()=>{ progress.currentIndex = i; renderQuestion(); renderPalette(); updateNavButtons(); };
    container.appendChild(b);
  });
}

/* ====== NAV BUTTON VISIBILITY ====== */
function updateNavButtons(){
  prevBtn.style.display = progress.currentIndex===0 ? 'none' : 'inline-block';
  nextBtn.style.display = progress.currentIndex===examData.files.length-1 ? 'none' : 'inline-block';
}

/* ====== SUBMIT EXAM: SUBJECT-WISE + TOTAL ROW ====== */
function submitExam(){
  clearInterval(timerInterval);
  // per-subject aggregation
  const subjData = {};
  examData.subjectNames.forEach((sub,i)=>{
    if(!subjData[sub]) subjData[sub] = {correct:0, wrong:0, blank:0, total:0};
    const ans = progress.answers[i];
    if(ans===null) subjData[sub].blank++;
    else if(ans===examData.keys[i]) subjData[sub].correct++;
    else subjData[sub].wrong++;
    subjData[sub].total++;
  });

  try{ storeAttemptLocal(progress.student); }catch(e){}

  // build result HTML with student header and table; table width increased by 30% (130%)
  let html = `<h2 style="color:#4B0082;">RESULT</h2>
  <div style="text-align:center;font-weight:bold;margin-bottom:10px;">
    Student: ${progress.student.name} | Section: ${progress.student.sec} | Roll: ${progress.student.roll} | Adm: ${progress.student.adm}
  </div>`;

  html += `<table border="1" style="border-collapse:collapse;width:130%;margin:0 auto;text-align:center;">
    <tr style="background:#E6E6FA;">
      <th>Subject</th><th>Correct</th><th>Wrong</th><th>Blank</th><th>Total</th><th>%</th>
    </tr>`;

  // ensure Maths, Physics, Chemistry always appear in that order
  const ordered = ["Maths","Physics","Chemistry"];
  let totC=0, totW=0, totB=0, totQ=0;
  ordered.forEach(sub=>{
    const s = subjData[sub] || {correct:0,wrong:0,blank:0,total:0};
    const perc = s.total ? ((s.correct/s.total)*100).toFixed(2) : "0.00";
    html += `<tr style="background:#fff;">
      <td>${sub}</td>
      <td style="text-align:center;">${s.correct}</td>
      <td style="text-align:center;">${s.wrong}</td>
      <td style="text-align:center;">${s.blank}</td>
      <td style="text-align:center;">${s.total}</td>
      <td style="text-align:center;">${perc}%</td>
    </tr>`;
    totC += s.correct; totW += s.wrong; totB += s.blank; totQ += s.total;
  });

  const totPerc = totQ ? ((totC/totQ)*100).toFixed(2) : "0.00";
  html += `<tr style="background:#D8BFD8;font-weight:bold;">
    <td>Total</td>
    <td style="text-align:center;">${totC}</td>
    <td style="text-align:center;">${totW}</td>
    <td style="text-align:center;">${totB}</td>
    <td style="text-align:center;">${totQ}</td>
    <td style="text-align:center;">${totPerc}%</td>
  </tr></table>`;

  html += `<p style="text-align:center;margin-top:15px;color:#4B0082;font-weight:bold;">Thank you for attempting the exam!</p>`;
  html += `<div style="text-align:center;margin-top:10px;"><button id="finalLogoutBtn">Logout</button></div>`;

  document.body.innerHTML = html;

  document.getElementById('finalLogoutBtn').onclick = function(){
    try{ window.close(); }catch(e){}
    window.location.href = 'about:blank';
  };
}

/* ====== RED OVERLAY / ACCESS DENIED (password bypass 'lfjc2025') ====== */
function showRedOverlay(){
  const overlay = document.getElementById('fullRedOverlay');
  overlay.innerHTML = '';
  for(let i=0;i<7;i++){
    const s = document.createElement('div'); s.className='overlay-slice'; s.style.left = (i*100/7)+'%'; overlay.appendChild(s);
  }
  overlay.style.display='block';
  const access = document.getElementById('accessDeniedBox');
  access.style.display='block';
  document.getElementById('callAdminBtn').onclick = function(){
    const pw = prompt('Enter password to bypass:');
    if(pw === 'lfjc2025'){
      overlay.style.display='none';
      access.style.display='none';
      overlay.innerHTML = '';
      if(pendingAttempt){
        try{
          document.getElementById('stuName').value = pendingAttempt.name || '';
          document.getElementById('stuSection').value = pendingAttempt.sec || '';
          document.getElementById('stuRoll').value = pendingAttempt.roll || '';
          document.getElementById('stuAdm').value = pendingAttempt.adm || '';
          validateStudentInputs();
        }catch(e){}
        pendingAttempt = null;
      }
    } else {
      alert('Wrong password!');
    }
  };
}

/* ====== Ensure global UI refs exist (safe access) ====== */
const studentEntry = document.getElementById('studentEntry');
const examArea = document.getElementById('examArea');

/* ====== End of script ====== */
</script>
</body>
</html>
